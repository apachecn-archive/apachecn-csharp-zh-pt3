第一章

![image](img/frontdot.jpg)

性能指标

在我们开始进入。NET 性能，我们必须了解性能测试和优化中涉及的指标和目标。在第 2 章中，我们探索了十几种剖析器和监控工具；然而，要使用这些工具，您需要知道您对哪些性能指标感兴趣。

不同类型的应用有多种不同的性能目标，由业务和运营需求驱动。有时，应用的体系结构决定了重要的性能指标:例如，知道您的 Web 服务器必须服务于数百万并发用户，就决定了具有缓存和负载平衡的多服务器分布式系统。在其他时候，性能测量结果可能需要改变应用的架构:我们已经看到无数的系统在压力测试运行后被重新设计——或者更糟，系统在生产环境中失败。

根据我们的经验，了解系统的性能目标及其环境的限制通常会引导您完成改进其性能的大半过程。以下是我们在过去几年中能够诊断和修复的一些示例:

*   我们发现托管数据中心的强大 Web 服务器存在严重的性能问题，这是由测试工程师使用的共享低延迟 4Mbps 链路引起的。由于不了解关键的性能指标，工程师们浪费了几十天的时间来调整 Web 服务器的性能，而实际上它运行得非常好。
*   我们能够通过调整 CLR 垃圾收集器(一个明显不相关的组件)的行为来提高富 UI 应用中的滚动性能。精确的时间分配和对 GC 风格的调整消除了困扰用户的明显的 UI 延迟。
*   通过将硬盘移动到 SATA 端口，我们能够将编译时间提高 10 倍，以解决微软 SCSI 磁盘驱动程序中的一个错误。
*   我们通过调优 WCF 的序列化机制，将 WCF 服务交换的消息大小减少了 90 %，大大提高了其可伸缩性和 CPU 利用率。
*   对于一个在过时硬件上有 300 个程序集的大型应用，我们通过压缩应用的代码，并仔细理清它的一些依赖关系，使它们在加载时不再需要，从而将启动时间从 35 秒减少到 12 秒。

这些例子旨在说明，从低功耗触摸设备、具有强大显卡的高端消费类工作站，到多服务器数据中心，每种系统都因无数微妙因素的相互作用而展现出独特的性能特征。在这一章中，我们简要地探讨了典型现代软件中的各种性能度量和目标。在下一章中，我们将说明如何准确地测量这些指标；本书的其余部分展示了如何系统地改进它们。

绩效目标

性能目标更多地取决于应用的领域和架构。当您收集完需求后，您应该确定一般的性能目标。根据您的软件开发过程，随着需求的变化和新的业务和操作需求的出现，您可能需要调整这些目标。我们回顾了几个原型应用的性能目标和指导原则的例子，但是，和任何与性能相关的东西一样，这些指导原则需要适应您的软件领域。

首先，这里有一些陈述的例子，说明*不是*的良好绩效目标:

*   当许多用户同时访问购物车屏幕时，应用将保持响应。
*   只要用户数量合理，应用就不会使用不合理的内存量。
*   即使有多个满载的应用服务器，单个数据库服务器也能快速提供查询服务。

这些陈述的主要问题是它们过于笼统和主观。如果这些是你的绩效目标，那么你一定会发现它们在参照系上有不同的解释和分歧。业务分析师可能认为 100，000 个并发用户是一个“合理”的数字，而技术团队成员可能知道可用的硬件无法在单台机器上支持这么多的用户。相反，开发人员可能会认为 500 ms 的响应时间是“响应性的”，但是用户界面专家可能会认为这是滞后的和不完善的。

然后，一个性能目标用*可量化的性能指标*来表达，这些指标可以通过一些性能测试的方法*来测量*。绩效目标还应该包含一些关于其*环境* 的信息——一般的或者特定于该绩效目标的信息。一些明确的绩效目标的例子包括:

*   只要并发访问购物车屏幕的用户不超过 5，000 人，该应用将在不到 300 毫秒的时间内(不包括网络往返时间)为“重要”类别中的每个页面提供服务。
*   对于每个空闲用户会话，应用将使用不超过 4 KB 的内存。
*   数据库服务器的 CPU 和磁盘利用率不应超过 70%，并且只要访问它的应用服务器不超过 10 个，它应该在 75 毫秒内返回对“普通”类别查询的响应。

![image](img/sq.jpg) **注意**这些例子假设“重要”页面类别和“常见”查询类别是由业务分析师或应用架构师定义的众所周知的术语。保证应用中每个角落的性能目标通常是不合理的，不值得在开发、硬件和运营成本上投资。

我们现在考虑一些典型应用的性能目标示例(见表 [**1-1**](#Tab00011) )。此列表绝非详尽无遗，也不打算用作您自己的绩效目标的清单或模板——它是一个通用框架，在涉及不同的应用类型时，可以确定不同的绩效目标。

[表 1-1](#_Tab00011) 。典型应用的性能目标示例

| 系统类型 | 绩效目标 | 环境约束 |
| --- | --- | --- |
| 外部 Web 服务器 | 从请求开始到生成完整响应的时间不应超过 300 毫秒 | 不超过 300 个并发活动请求 |
| 外部 Web 服务器 | 虚拟内存使用量(包括缓存)不应超过 1.3GB | 不超过 300 个并发活动请求；不超过 5，000 个连接的用户会话 |
| 应用服务器 | CPU 利用率不应超过 75% | 不超过 1，000 个并发活动 API 请求 |
| 应用服务器 | 硬页面错误率不应超过每秒 2 个硬页面错误 | 不超过 1，000 个并发活动 API 请求 |
| 智能客户端应用 | 从双击桌面快捷方式到主屏幕显示员工列表的时间不应超过 1500 毫秒 | - |
| 智能客户端应用 | 应用空闲时的 CPU 利用率不应超过 1% | - |
| 网页 | 过滤和分类收到的电子邮件的时间不应超过 750 毫秒，包括播放动画 | 单个屏幕上显示的接收邮件不超过 200 封 |
| 网页 | “与代表聊天”窗口的缓存 JavaScript 对象的内存利用率不应超过 2.5MB | - |
| 监控服务 | 从故障事件到生成和发送警报的时间不应超过 25 毫秒 | - |
| 监控服务 | 未主动生成警报时，磁盘 I/O 操作率应为 0 | - |

![image](img/sq.jpg) **注意**运行应用的硬件特性是环境约束的重要组成部分。例如，表 [** 1-1 **](#Tab00011) 中对智能客户端应用的启动时间限制可能要求固态硬盘或转速至少为 7200RPM 的旋转硬盘、至少 2GB 的系统内存以及支持 SSE3 指令的 1.2GHz 或更快的处理器。这些环境约束不值得为每个性能目标重复，但是在性能测试期间值得记住。

当性能目标被很好地定义时，性能测试、负载测试和随后的优化过程就很简单了。验证假设，例如“对于 1，000 个并发执行的 API 请求，应用服务器上每秒出现的硬页面错误少于 2 个”，通常需要访问负载测试工具和合适的硬件环境。下一章将讨论如何度量应用，以确定一旦建立了这样的环境，它是否达到或超过了它的性能目标。

构建定义良好的性能目标通常需要事先熟悉性能指标，我们将在下面讨论。

绩效指标

与绩效目标不同，绩效指标与特定的场景或环境无关。性能指标是反映应用行为的可测量的数字量。您可以在任何硬件和任何环境中测量性能指标，而不管活动用户、请求或会话的数量。在开发生命周期中，您选择度量标准来度量并从中导出特定的性能目标。

一些应用具有特定于其领域的性能指标。我们不打算在这里确定这些指标。相反，我们在表 [**1-2**](#Tab00012) 中列出了对许多应用来说非常重要的性能指标，以及讨论这些指标优化的章节。(CPU 利用率和执行时间指标非常重要，本书的每一章都会在*中讨论。)*

[表 1-2](#_Tab00012) 。绩效指标列表(部分)

| 绩效指标 | 计量单位 | 本书中的特定章节 |
| --- | --- | --- |
| CPU 利用率 | 百分比 | 所有章节 |
| 物理/虚拟内存使用情况 | 字节、千字节、兆字节、千兆字节 | [第 4 章](04.html)–垃圾收集[第 5 章](05.html)–收集和泛型 |
| 缓存未命中 | 计数，速率/秒 | [第 5 章](05.html)–集合和泛型[第 6 章](06.html)–并发和并行 |
| 页面错误 | 计数，速率/秒 | - |
| 数据库访问计数/计时 | 计数，速率/秒，毫秒 | - |
| 分配 | 字节数、对象数、速率/秒 | [第 3 章](03.html)–类型内部构件[第 4 章](04.html)–垃圾收集 |
| 执行时间 | 毫秒 | 所有章节 |
| 网络运营 | 计数，速率/秒 | [第 7 章](07.html)–网络、I/O 和序列化[第 11 章](11.html)–网络应用 |
| 磁盘操作 | 计数，速率/秒 | [第 7 章](07.html)—网络、I/O 和序列化 |
| 响应时间 | 毫秒 | [第十一章](11.html)–网络应用 |
| 垃圾收集 | 计数，速率/秒，持续时间(毫秒)，占总时间的百分比 | [第 4 章](04.html)–垃圾收集 |
| 引发的异常 | 计数，速率/秒 | [第 10 章](10.html)–绩效模式 |
| 启动时间 | 毫秒 | [第 10 章](10.html)–绩效模式 |
| 引起争论的 | 计数，速率/秒 | [第 6 章](06.html)—并发和并行 |

有些指标与某些应用类型的相关性比其他的更强。例如，数据库访问时间不是您可以在客户端系统上测量的指标。性能指标和应用类型的一些常见组合包括:

*   对于客户端应用，您可能会关注启动时间、内存使用和 CPU 利用率。
*   对于托管系统算法的服务器应用，您通常关注 CPU 利用率、缓存未命中、争用、分配和垃圾收集。
*   对于 Web 应用，通常测量内存使用、数据库访问、网络和磁盘操作以及响应时间。

关于性能指标的最后一个观察是，在没有显著改变指标意义的情况下，通常可以改变它们被测量的级别。例如，分配和执行时间可以在系统级、单个进程级，甚至是单个方法和行进行测量。与整体 CPU 利用率或流程级别的执行时间相比，特定方法中的执行时间可能是更具可操作性的性能指标。不幸的是，增加测量的粒度通常会导致性能开销，我们将在下一章通过讨论各种分析工具来说明这一点。

软件开发生命周期中的性能

您认为性能在软件开发生命周期中处于什么位置？这个天真的问题带来了一个包袱，那就是必须在现有的流程中改进 T2 的性能。虽然这是可能的，但更健康的方法是将开发生命周期的每一步都视为更好地理解应用性能的机会:首先，性能目标和重要的度量标准；接下来，应用是否达到或超过其目标；最后，维护、用户负载和需求变更是否会引入任何回归。

1.  在需求收集阶段，开始考虑您想要设定的性能目标。
2.  在架构阶段，细化对应用重要的性能指标，并定义具体的性能目标。
3.  在开发阶段，经常对原型代码或部分完成的特性执行探索性的性能测试，以验证您完全符合系统的性能目标。
4.  在测试阶段，执行重要的负载测试和性能测试，以完全验证系统的性能目标。
5.  在后续的开发和维护过程中，对每个版本执行额外的负载测试和性能测试(最好是每天或每周一次)，以快速识别系统中引入的任何性能退化。

Taking the time to develop a suite of automatic load tests and performance tests, set up an isolated lab environment in which to run them, and analyze their results carefully to make sure no regressions are introduced is very time-consuming. Nevertheless, the performance benefits gained from systematically measuring and improving performance and making sure regressions do not creep slowly into the system is worth the initial investment in having a robust performance development process.

摘要

这一章是对性能指标和目标的介绍。确保你知道*衡量什么*和什么样的绩效标准对你来说是重要的，这甚至比实际的*衡量*绩效更重要，这是下一章的主题。在本书的其余部分，我们使用各种工具来衡量性能，并提供如何改进和优化应用的指导。